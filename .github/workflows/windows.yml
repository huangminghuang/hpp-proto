---
name: Windows

on:
  workflow_dispatch:
  push:
    branches:
      - main
      - develop
      - dev/**
    paths-ignore:
        - '**.md'
  pull_request:
    branches:
      - main
      - develop
    paths-ignore:
        - '**.md'

env:
  CTEST_OUTPUT_ON_FAILURE: 1
  CPM_SOURCE_CACHE: ${{ github.workspace }}/cpm_modules
  CCACHE_DIR: ${{ github.workspace }}/.ccache

jobs:
  build:
    runs-on: windows-latest
    strategy:
      matrix:
        include:
          - cmake_preset: ci-windows-msvc-release
            compiler_env: msvc
          - cmake_preset: ci-windows-mingw-release
            compiler_env: mingw

    steps:
      - uses: actions/checkout@v6

      - uses: ilammy/msvc-dev-cmd@v1
        if: ${{ matrix.compiler_env == 'msvc' }}

      - name: Setup MinGW
        if: ${{ matrix.compiler_env == 'mingw' }}
        uses: msys2/setup-msys2@v2
        with:
          update: true
          install: mingw-w64-x86_64-gcc

      - name: Add MinGW to PATH
        if: ${{ matrix.compiler_env == 'mingw' }}
        shell: pwsh
        run: Add-Content -Path $env:GITHUB_PATH -Value "C:\msys64\mingw64\bin"

      - uses: actions/cache@v5
        with:
          path: "**/cpm_modules"
          key: ${{ github.workflow }}-cpm-modules-${{ hashFiles('**/third-parties.cmake') }}

      - name: Cache ccache
        uses: actions/cache@v5
        with:
          path: ${{ env.CCACHE_DIR }}
          key: ${{ github.workflow }}-${{ runner.os }}-${{ matrix.cmake_preset }}-${{ matrix.compiler_env }}-ccache-${{ github.sha }}
          restore-keys: |
            ${{ github.workflow }}-${{ runner.os }}-${{ matrix.cmake_preset }}-${{ matrix.compiler_env }}-ccache-

      - name: Setup required C++ tools
        uses: aminya/setup-cpp@v1.8.0
        with:
          cmake: "3.31.0"
          ninja: true
          ccache: true

      - name: Install Protoc
        shell: pwsh
        run: |
          $version = "33.5"
          $zip = "protoc-$version-win64.zip"
          $sha256 = "7e3468cd1fbd1ae9361a5304d4ac28fbd593aa1a425b5464bd9d4da5fca224b4"
          $url = "https://github.com/protocolbuffers/protobuf/releases/download/v$version/$zip"
          $dest = "$env:RUNNER_TEMP\protoc"
          $zipPath = "$dest\$zip"
          New-Item -ItemType Directory -Force -Path $dest | Out-Null
          Invoke-WebRequest -Uri $url -OutFile $zipPath
          $actual = (Get-FileHash -Path $zipPath -Algorithm SHA256).Hash.ToLowerInvariant()
          if ($actual -ne $sha256) {
            throw "Checksum mismatch for $zip. Expected $sha256, got $actual"
          }
          Expand-Archive -Path $zipPath -DestinationPath $dest -Force
          Add-Content -Path $env:GITHUB_PATH -Value "$dest\bin"
          Add-Content -Path $env:GITHUB_ENV -Value "PROTOC_BIN=$dest\bin"

      - name: configure
        run: cmake --preset "${{ matrix.cmake_preset }}"

      - name: build
        run: cmake --build build

      - name: test
        run: ctest --test-dir build --output-on-failure
