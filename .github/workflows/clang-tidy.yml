name: Clang-Tidy 21

on:
  workflow_dispatch:
  push:
    branches:
      - main
      - develop
      - dev/**
    paths-ignore:
      - '**.md'
  pull_request:
    branches:
      - main
      - develop
    paths-ignore:
      - '**.md'

env:
  CPM_SOURCE_CACHE: ${{ github.workspace }}/cpm_modules
  CCACHE_DIR: ${{ github.workspace }}/.ccache

jobs:
  clang-tidy:
    runs-on: ubuntu-24.04
    steps:
      - uses: actions/checkout@v6
        with:
          fetch-depth: 0

      - name: Detect changed C/C++ files (PR)
        id: changes
        shell: bash
        run: |
          if [[ "${{ github.event_name }}" != "pull_request" ]]; then
            echo "has_cpp_changes=true" >> "$GITHUB_OUTPUT"
            echo "changed_cpp_files=" >> "$GITHUB_OUTPUT"
            exit 0
          fi

          git fetch --no-tags --prune --depth=1 origin "${{ github.base_ref }}"
          BASE="origin/${{ github.base_ref }}"
          CHANGED="$(git diff --name-only --diff-filter=ACMR "$BASE...HEAD" | grep -E '\.(c|cc|cpp|cxx)$' || true)"

          if [[ -z "$CHANGED" ]]; then
            echo "has_cpp_changes=false" >> "$GITHUB_OUTPUT"
            echo "changed_cpp_files=" >> "$GITHUB_OUTPUT"
          else
            echo "has_cpp_changes=true" >> "$GITHUB_OUTPUT"
            {
              echo "changed_cpp_files<<EOF"
              echo "$CHANGED"
              echo "EOF"
            } >> "$GITHUB_OUTPUT"
          fi

      - name: Prepare cache directories
        if: github.event_name != 'pull_request' || steps.changes.outputs.has_cpp_changes == 'true'
        run: |
          mkdir -p "${CPM_SOURCE_CACHE}"
          mkdir -p "${CCACHE_DIR}"

      - uses: actions/cache@v5
        if: github.event_name != 'pull_request' || steps.changes.outputs.has_cpp_changes == 'true'
        with:
          path: ${{ env.CPM_SOURCE_CACHE }}
          key: clang-tidy-${{ runner.os }}-${{ hashFiles('**/third-parties.cmake') }}

      - name: Cache ccache
        if: github.event_name != 'pull_request' || steps.changes.outputs.has_cpp_changes == 'true'
        uses: actions/cache@v5
        with:
          path: ${{ env.CCACHE_DIR }}
          key: clang-tidy-${{ runner.os }}-ccache-${{ github.sha }}
          restore-keys: |
            clang-tidy-${{ runner.os }}-ccache-

      - name: Setup required C++ tools
        if: github.event_name != 'pull_request' || steps.changes.outputs.has_cpp_changes == 'true'
        uses: aminya/setup-cpp@v1.8.0
        with:
          compiler: llvm-21
          cmake: "3.31.0"
          ninja: true
          ccache: true
          clang-tidy: true

      - name: Install protobuf dependencies
        if: github.event_name != 'pull_request' || steps.changes.outputs.has_cpp_changes == 'true'
        run: |
          sudo apt-get update
          sudo apt-get install -y protobuf-compiler libprotobuf-dev libgrpc++-dev protobuf-compiler-grpc

      - name: Configure (full clang-tidy on push/dispatch)
        if: github.event_name != 'pull_request'
        run: |
          cmake -GNinja -S . -B build -DCMAKE_BUILD_TYPE=Release \
                -DHPP_PROTO_PROTOC=find \
                -DCMAKE_C_COMPILER=clang \
                -DCMAKE_CXX_COMPILER=clang++ \
                -DCMAKE_C_COMPILER_LAUNCHER=ccache \
                -DCMAKE_CXX_COMPILER_LAUNCHER=ccache \
                -DCMAKE_C_CLANG_TIDY="clang-tidy;-warnings-as-errors=*" \
                -DCMAKE_CXX_CLANG_TIDY="clang-tidy;-warnings-as-errors=*"

      - name: Configure (PR build)
        if: github.event_name == 'pull_request' && steps.changes.outputs.has_cpp_changes == 'true'
        run: |
          cmake -GNinja -S . -B build -DCMAKE_BUILD_TYPE=Release \
                -DHPP_PROTO_PROTOC=find \
                -DCMAKE_C_COMPILER=clang \
                -DCMAKE_CXX_COMPILER=clang++ \
                -DCMAKE_C_COMPILER_LAUNCHER=ccache \
                -DCMAKE_CXX_COMPILER_LAUNCHER=ccache \
                -DCMAKE_EXPORT_COMPILE_COMMANDS=ON

      - name: Build
        if: github.event_name != 'pull_request'
        run: cmake --build build -j"$(nproc)"

      - name: Clang-tidy changed files (PR)
        if: github.event_name == 'pull_request' && steps.changes.outputs.has_cpp_changes == 'true'
        shell: bash
        run: |
          CHANGED="${{ steps.changes.outputs.changed_cpp_files }}"
          echo "Running clang-tidy on changed files:"
          echo "$CHANGED"
          while IFS= read -r file; do
            clang-tidy -p build --warnings-as-errors='*' "$file"
          done <<< "$CHANGED"

      - name: No changed C/C++ files (PR)
        if: github.event_name == 'pull_request' && steps.changes.outputs.has_cpp_changes != 'true'
        run: echo "No changed C/C++ files detected. Skipping clang-tidy workflow steps."
