name: Conan Windows

on:
  workflow_dispatch:
  push:
    branches:
      - main
      - develop
      - dev/**
    paths-ignore:
      - "**.md"
  pull_request:
    branches:
      - main
      - develop
    paths-ignore:
      - "**.md"

env:
  CTEST_OUTPUT_ON_FAILURE: 1
  PROTOC_VERSION: "34.0"
  PROTOC_ZIP: protoc-34.0-win64.zip
  PROTOC_SHA256: 76ddeb5ae7a31c8f9f7759d3b843a4cadda2150ac037ad0c1794665d6cf31fce
  CCACHE_DIR: ${{ github.workspace }}/.ccache

jobs:
  build:
    runs-on: windows-latest
    strategy:
      fail-fast: false
      matrix:
        include:
          - name: conan-protobuf-binary
            with_protobuf: "True"
            cmake_configure_preset: conan-default
            cmake_build_preset: conan-release
          - name: system-protobuf-cpp23
            with_protobuf: "False"
            cmake_configure_preset: conan-default
            cmake_build_preset: conan-release
    name: ${{ matrix.name }}

    steps:
      - uses: actions/checkout@v6

      - name: setup cpp tools
        uses: aminya/setup-cpp@v1.8.0
        with:
          cmake: "3.31.0"
          ninja: true
          ccache: true
          conan: "2.25.2"

      - name: Cache ccache
        uses: actions/cache@v5
        with:
          path: ${{ env.CCACHE_DIR }}
          key: ${{ github.workflow }}-${{ runner.os }}-${{ matrix.name }}-ccache-${{ github.sha }}
          restore-keys: |
            ${{ github.workflow }}-${{ runner.os }}-${{ matrix.name }}-ccache-

      - name: install protoc
        run: |
          $zip = "$env:TEMP\\$env:PROTOC_ZIP"
          Invoke-WebRequest -Uri "https://github.com/protocolbuffers/protobuf/releases/download/v$env:PROTOC_VERSION/$env:PROTOC_ZIP" -OutFile $zip
          $actual = (Get-FileHash -Path $zip -Algorithm SHA256).Hash.ToLowerInvariant()
          $expected = "$env:PROTOC_SHA256".ToLowerInvariant()
          if ($actual -ne $expected) {
            throw "Checksum mismatch for $env:PROTOC_ZIP. Expected $expected, got $actual"
          }
          Expand-Archive -Path $zip -DestinationPath "$env:TEMP\\protoc"
          Add-Content $env:GITHUB_PATH "$env:TEMP\\protoc\\bin"

      - name: conan profile
        run: conan profile detect --force

      - name: create package
        run: |
          conan create . `
            -s:h build_type=Release `
            -s:h compiler.cppstd=23 `
            -s:b build_type=Release `
            -s:b compiler.cppstd=17 `
            -o "&:with_protobuf=${{ matrix.with_protobuf }}" `
            --build=missing

      - name: install dependencies
        run: |
          conan install tutorial `
            -s:h build_type=Release `
            -s:b build_type=Release `
            -s:h compiler.cppstd=23 `
            -s:b compiler.cppstd=17 `
            -o "hpp_proto/*:with_protobuf=${{ matrix.with_protobuf }}" `
            --build=missing `
            -of tutorial-build

      - name: configure
        run: cmake -S tutorial --preset "${{ matrix.cmake_configure_preset }}"

      - name: build
        run: |
          cd tutorial
          cmake --build --preset "${{ matrix.cmake_build_preset }}" -j2

      - name: test
        run: |
          cd tutorial
          ctest --preset "${{ matrix.cmake_build_preset }}" --output-on-failure
